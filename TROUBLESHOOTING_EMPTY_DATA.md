# حل مشكلة البيانات الفارغة

## المشكلة
البوت يعمل ويتصل بـ Google Sheets لكن البيانات المستخرجة من موقع الانتخابات تكون فارغة.

## السبب
موقع الانتخابات (elections.eg) يتغير هيكله باستمرار. الكود يحتاج للتحديث ليتوافق مع الهيكل الجديد.

## التحديثات التي تمت (2025-10-28)

### 1. إصلاح اختيار iframe الصحيح ✅
- **المشكلة السابقة**: الكود كان يدخل على أول iframe (إعلانات/cookies) بدلاً من iframe الاستعلام
- **الحل**: 
  * فحص جميع iframes
  * اختيار iframe الذي يحتوي على 'inquiry' أو 'gadget' في src
  * إذا لم يُعثر عليه، البحث عن iframe الذي يحتوي على حقل الرقم القومي

### 2. إضافة طرق جديدة للاستخراج ✅
الكود الآن يستخدم 4 طرق مختلفة للاستخراج (بالترتيب):

**الطريقة 1**: استخراج من عناصر محددة بـ IDs/Classes
- مركز الانتخاب: `centerName`, `center-name`, `votingCenter`, `voting-center`
- العنوان: `address`, `centerAddress`, `center-address`
- رقم اللجنة: `committeeNumber`, `committee-number`, `subCommittee`
- الرقم في الكشوف: `orderNumber`, `order-number`, `listNumber`

**الطريقة 2**: استخراج من جداول HTML (Selenium)
- يبحث عن صفوف الجدول `<tr>`
- يقرأ التسمية من `cells[0]` والقيمة من `cells[-1]`

**الطريقة 3**: استخراج من جداول HTML (BeautifulSoup)
- نفس المنطق لكن باستخدام BeautifulSoup

**الطريقة 4**: البحث في جميع العناصر النصية
- يبحث عن كلمات مفتاحية عربية مثل "مركز", "عنوان", "لجنة", "كشوف"

### 3. Screenshot تلقائي للتصحيح ✅
- عند فشل استخراج البيانات، يتم حفظ screenshot بتسمية `debug_screenshot_{رقم_قومي}.png`
- يمكنك فحص هذا الملف لمعرفة ما يظهر في الموقع بالفعل

## ما يجب فعله الآن

### الخطوة 1: تشغيل سكريبت الاختبار
```bash
python test_website_structure.py
```

هذا السكريبت:
- يفتح موقع الانتخابات
- يفحص جميع iframes
- يدخل رقم قومي اختباري
- يحفظ screenshot ويطبع هيكل HTML
- ينشئ ملفات: `test_result_screenshot.png` و `test_result.html`

### الخطوة 2: فحص النتائج

افحص الملفات المنشأة:
- `test_result_screenshot.png` - صورة للموقع بعد إدخال الرقم القومي
- `test_result.html` - كود HTML الكامل للصفحة
- `test_output.txt` - رسائل التصحيح التفصيلية

### الخطوة 3: تحديد العناصر الصحيحة

#### أ) باستخدام المتصفح (الطريقة المفضلة)
1. افتح https://www.elections.eg/inquiry في متصفحك
2. أدخل رقم قومي حقيقي
3. اضغط F12 لفتح Developer Tools
4. اضغط Ctrl+Shift+C (أو ⌘+Shift+C على Mac)
5. اضغط على "مركز الانتخاب" في النتيجة
6. سترى الكود HTML مثل:
   ```html
   <div id="centerName" class="result-value">الوحدة المحلية براس الحكمة</div>
   ```
7. لاحظ `id` و `class` للعنصر

#### ب) أو باستخدام الملفات المحفوظة
افتح `test_result.html` في محرر نصوص وابحث عن:
- نص "مركز الانتخاب" أو "المركز"
- نص "العنوان" أو "عنوان اللجنة"
- نص "اللجنة الفرعية"
- نص "الرقم في الكشوف"

## كيفية تحديث الكود

### إذا وجدت IDs/Classes جديدة

افتح ملف `main.py` وابحث عن السطر 342:
```python
selectors_map = {
    'مركز_الانتخاب': ['centerName', 'center-name', 'votingCenter', 'voting-center', 'المركز'],
    'العنوان': ['address', 'centerAddress', 'center-address', 'العنوان'],
    'رقم_اللجنة_الفرعية': ['committeeNumber', 'committee-number', 'subCommittee', 'اللجنة'],
    'الرقم_في_الكشوف': ['orderNumber', 'order-number', 'listNumber', 'الرقم']
}
```

أضف IDs/Classes الجديدة التي وجدتها في القائمة.

**مثال**: إذا وجدت أن مركز الانتخاب له `id="polling-center"`، أضفه هكذا:
```python
'مركز_الانتخاب': ['centerName', 'center-name', 'polling-center', 'votingCenter', 'voting-center', 'المركز'],
```

### إذا كان الموقع يستخدم هيكل مختلف كلياً

في هذه الحالة، اتصل بي مع:
1. ملف `test_result.html`
2. صورة `test_result_screenshot.png`
3. وصف لما تراه في النتيجة عند الاستعلام يدوياً

سأقوم بتحديث الكود بناءً على هذه المعلومات.

## أمثلة على المشاكل الشائعة

### المشكلة: الموقع لا يرد
```
الحالة: error
ملاحظات: تم اكتشاف Captcha
```
**الحل**: انتظر 10-15 دقيقة وجرب مرة أخرى. قد تحتاج لتقليل السرعة (زيادة `time.sleep`)

### المشكلة: iframe خاطئ
```
في Logs:
وجدت 2 إطار iframe
iframe 0: src=https://cookies-consent.com/...
iframe 1: src=https://gadget.elections.eg/...
```
**الحل**: الكود محدّث الآن ليتعامل مع هذا تلقائياً

### المشكلة: البيانات فارغة لكن لا أخطاء
```
الحالة: no_data
ملاحظات: لم يتم العثور على بيانات
```
**الحل**: 
1. تحقق من ملف `debug_screenshot_{رقم}.png` 
2. شغّل `test_website_structure.py`
3. حدّث `selectors_map` في الكود

## نصائح إضافية

### لتسريع التطوير
1. استخدم رقم قومي واحد فقط للاختبار في Google Sheet
2. شغّل البوت وراقب الرسائل في console
3. فحص screenshot المحفوظ
4. حدّث الكود
5. أعد المحاولة

### للاستخدام في الإنتاج
بعد التأكد أن الكود يعمل:
1. احذف ملفات الاختبار: `debug_screenshot_*.png`
2. امسح `progress.json` للبدء من الصف الأول
3. شغّل البوت: `python main.py`

## طلب المساعدة

إذا جربت كل ما سبق ومازالت المشكلة موجودة، أرسل:
1. ملف `test_result.html` (كامل)
2. صورة `test_result_screenshot.png`
3. آخر 50 سطر من console logs
4. مثال على رقم قومي يعمل في الموقع يدوياً

سأقوم بتحديث الكود المحدد لموقع الانتخابات الحالي.
