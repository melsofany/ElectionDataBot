# أداة استعلام بيانات الناخبين من الهيئة العليا للانتخابات

أداة تلقائية لاستخراج بيانات الناخبين من موقع الهيئة العليا للانتخابات المصرية باستخدام الأرقام القومية المخزنة في Google Sheets.

## المميزات

✅ قراءة الأرقام القومية والأسماء تلقائياً من Google Sheets  
✅ الاستعلام التلقائي عن كل رقم قومي من موقع الهيئة العليا للانتخابات  
✅ استخراج البيانات التالية:
- مركز الانتخاب
- العنوان
- رقم اللجنة الفرعية
- الرقم في الكشوف الانتخابية

✅ كتابة النتائج في شيت Google جديد بشكل منظم  
✅ نظام متقدم للمتابعة والاستئناف (Resume)  
✅ دعم معالجة حتى 80,000 صف  
✅ عرض حالة التقدم بشكل مباشر  

## المتطلبات الأساسية

### 1. Google Service Account Credentials

لكي تعمل الأداة، تحتاج إلى ملف `credentials.json` من Google Cloud Console.

#### خطوات الحصول على ملف Credentials:

1. **إنشاء مشروع في Google Cloud Console**
   - اذهب إلى [Google Cloud Console](https://console.cloud.google.com/)
   - أنشئ مشروعاً جديداً (أو استخدم مشروعاً موجوداً)

2. **تفعيل الـ APIs المطلوبة**
   - ابحث عن "Google Sheets API" وقم بتفعيله
   - ابحث عن "Google Drive API" وقم بتفعيله

3. **إنشاء Service Account**
   - اذهب إلى **APIs & Services > Credentials**
   - اضغط **Create Credentials > Service Account**
   - أدخل اسماً للحساب واضغط **Done**

4. **إنشاء مفتاح JSON**
   - اضغط على Service Account الذي أنشأته
   - اذهب إلى تبويب **Keys**
   - اضغط **Add Key > Create new key**
   - اختر **JSON** واضغط **Create**
   - سيتم تحميل ملف JSON تلقائياً

5. **رفع الملف إلى المشروع**
   - قم بتسمية الملف بـ `credentials.json`
   - ضعه في المجلد الرئيسي للمشروع

6. **مشاركة Google Sheet مع Service Account**
   - افتح ملف `credentials.json`
   - ابحث عن `client_email` (مثل: `your-bot@project.iam.gserviceaccount.com`)
   - اذهب إلى Google Sheet الخاص بك
   - اضغط زر **مشاركة (Share)**
   - أضف البريد الإلكتروني للـ Service Account
   - امنحه صلاحيات **Editor**

## طريقة الاستخدام

### 1. تشغيل البرنامج

```bash
python main.py
```

### 2. هيكل ملف Google Sheets المطلوب

يجب أن يحتوي Google Sheet على ورقة باسم **Voters** تحتوي على:

| العمود A | العمود B (الأرقام القومية) | العمود C (الأسماء) |
|---------|----------------------------|-------------------|
| ...     | 29012011234567             | أحمد محمد          |
| ...     | 29103011234568             | فاطمة علي          |
| ...     | 29204011234569             | محمود حسن         |

**ملاحظات:**
- الأرقام القومية يجب أن تكون في **العمود B**
- الأسماء يجب أن تكون في **العمود C**
- الصف الأول (العناوين) سيتم تجاهله تلقائياً

### 3. النتائج

سيتم إنشاء ورقة جديدة باسم **نتائج_الاستعلام** تحتوي على:

| الاسم | الرقم القومي | مركز الانتخاب | العنوان | رقم اللجنة الفرعية | الرقم في الكشوف | الحالة | ملاحظات |
|------|-------------|--------------|---------|-------------------|----------------|--------|---------|
| أحمد محمد | 29012011234567 | ... | ... | ... | ... | success | |

## نظام المتابعة والاستئناف

البرنامج يحفظ التقدم تلقائياً في ملف `progress.json`:

```json
{
  "last_row": 150,
  "total_processed": 150,
  "last_updated": "2025-10-28T15:30:00"
}
```

**إذا توقف البرنامج لأي سبب:**
- قم بتشغيله مرة أخرى باستخدام `python main.py`
- سيبدأ تلقائياً من آخر صف تمت معالجته
- لن يتم إعادة معالجة الصفوف السابقة

**لإعادة البدء من الصفر:**
```bash
rm progress.json
python main.py
```

## إعدادات إضافية

يمكنك تعديل الإعدادات في بداية ملف `main.py`:

```python
SPREADSHEET_ID = "1-rCGPx6vyEMm3zmR7ks3xZh63XcJk4ks78e5e9jfuyo"  # معرف الـ Google Sheet
SOURCE_SHEET = "Voters"  # اسم الورقة المصدر
RESULTS_SHEET = "نتائج_الاستعلام"  # اسم ورقة النتائج
INQUIRY_URL = "https://www.elections.eg/inquiry"  # رابط موقع الاستعلام
MAX_ROWS = 80000  # الحد الأقصى للصفوف
```

## استكشاف الأخطاء

### خطأ: "لم يتم العثور على ملف credentials.json"
- تأكد من وجود ملف `credentials.json` في المجلد الرئيسي
- تأكد من كتابة الاسم بشكل صحيح

### خطأ: "SpreadsheetNotFound"
- تأكد من مشاركة Google Sheet مع Service Account Email
- تأكد من صحة SPREADSHEET_ID في الكود

### خطأ: "WorksheetNotFound"
- تأكد من وجود ورقة باسم "Voters" في Google Sheet
- تأكد من كتابة الاسم بشكل صحيح (حساس لحالة الأحرف)

### البرنامج بطيء جداً
- هذا طبيعي، البرنامج ينتظر 2-3 ثواني بين كل استعلام
- يمكنك تعديل `time.sleep(2)` في الكود لتسريع العملية
- **تحذير:** التسريع الزائد قد يؤدي لحجب IP من الموقع

## المكتبات المستخدمة

- `gspread` - التعامل مع Google Sheets
- `google-auth` - المصادقة مع Google APIs
- `selenium` - التحكم الآلي بالمتصفح
- `beautifulsoup4` - تحليل HTML
- `pandas` - معالجة البيانات
- `webdriver-manager` - إدارة ChromeDriver تلقائياً

## الترخيص

هذا المشروع مفتوح المصدر ومتاح للاستخدام الحر.

## ملاحظات مهمة

⚠️ **تنبيه قانوني:** هذه الأداة للاستخدام الشخصي والتعليمي فقط. يرجى احترام قوانين الاستخدام لموقع الهيئة العليا للانتخابات.

⚠️ **الأمان:** لا تشارك ملف `credentials.json` مع أحد أو تنشره على الإنترنت.

⚠️ **السرعة:** استخدم الأداة بشكل معتدل لتجنب حظر IP من الموقع.

⚠️ **تحديث هام:** موقع الهيئة يستخدم iframe من `gadget.elections.eg` للاستعلام. قد تحتاج لتحديث الكود ليتعامل مع iframe إذا لم تعمل البيانات بشكل صحيح. راجع التعليمات أدناه.

## كيفية تحديث استخراج البيانات

إذا لم تعمل الأداة بشكل صحيح (تظهر حقول فارغة)، قد يكون هيكل موقع الانتخابات قد تغير. اتبع الخطوات التالية:

1. **افتح موقع الانتخابات يدوياً:**
   - اذهب إلى: https://www.elections.eg/inquiry
   - أدخل رقماً قومياً تجريبياً
   - افحص النتيجة

2. **افحص عناصر الصفحة:**
   - اضغط F12 (أدوات المطور)
   - ابحث عن النصوص مثل "مركزك الإنتخابي" في HTML
   - حدد الـ CSS selectors الصحيحة

3. **حدّث الكود في main.py:**
   - ابحث عن دالة `query_election_data`
   - عدّل طرق استخراج البيانات حسب الهيكل الجديد

4. **تعامل مع iframe (إذا كان موجوداً):**
   ```python
   # إضافة هذا الكود قبل استخراج البيانات
   try:
       self.driver.switch_to.frame("iframe_name_or_id")
   except:
       pass  # لا يوجد iframe
   ```
